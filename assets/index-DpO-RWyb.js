(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class Q{samples;maxSamples;constructor(e){this.samples=[],this.maxSamples=e}get average(){return this.samples.reduce((e,t)=>e+t,0)/this.samples.length}addSample(e){this.samples.length===this.maxSamples&&this.samples.shift(),this.samples.push(e)}reset(){this.samples.splice(0,this.samples.length)}}class W{canTimestamp;querySet;resolveBuffer;resultBuffer;rollingAverage;onUpdate;constructor(e,t=()=>{}){this.canTimestamp=e.features.has("timestamp-query"),this.onUpdate=t,this.rollingAverage=new Q(50),this.canTimestamp&&(this.querySet=e.createQuerySet({label:"GPUTimer Query Set",type:"timestamp",count:2}),this.resolveBuffer=e.createBuffer({label:"GPUTimer Resolve Buffer",size:this.querySet.count*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=e.createBuffer({label:"GPUTimer Result Buffer",size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}));const s=e.queue.submit.bind(e.queue);e.queue.submit=i=>{s(i),this.canTimestamp&&e.queue.onSubmittedWorkDone().then(()=>{this.resultBuffer.mapState==="unmapped"&&this.resultBuffer.mapAsync(GPUMapMode.READ).then(()=>{const n=new BigInt64Array(this.resultBuffer.getMappedRange());this.rollingAverage.addSample(Number(n[1]-n[0])),this.resultBuffer.unmap(),this.onUpdate(this.rollingAverage.average)})})}}get time(){return this.rollingAverage.average}beginPass(e,t,s){const i={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1},n=e[t==="render"?"beginRenderPass":"beginComputePass"]({...s,...this.canTimestamp?{timestampWrites:i}:void 0}),o=n.end.bind(n);return n.end=()=>{o(),this.canTimestamp&&(e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),this.resultBuffer.mapState==="unmapped"&&e.copyBufferToBuffer(this.resolveBuffer,this.resultBuffer))},n}beginComputePass(e,t){return this.beginPass(e,"compute",t)}beginRenderPass(e,t){return this.beginPass(e,"render",t)}reset(){this.rollingAverage.reset()}}class G{components;constructor(){this.components=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static multiplyMatrices(e,t,s=new G){const i=e.components[0],n=e.components[1],o=e.components[2],r=e.components[3],h=e.components[4],c=e.components[5],p=e.components[6],f=e.components[7],l=e.components[8],m=e.components[9],x=e.components[10],d=e.components[11],v=e.components[12],B=e.components[13],S=e.components[14],T=e.components[15];let y=t.components[0],b=t.components[1],g=t.components[2],w=t.components[3];return s.components[0]=y*i+b*h+g*l+w*v,s.components[1]=y*n+b*c+g*m+w*B,s.components[2]=y*o+b*p+g*x+w*S,s.components[3]=y*r+b*f+g*d+w*T,y=t.components[4],b=t.components[5],g=t.components[6],w=t.components[7],s.components[4]=y*i+b*h+g*l+w*v,s.components[5]=y*n+b*c+g*m+w*B,s.components[6]=y*o+b*p+g*x+w*S,s.components[7]=y*r+b*f+g*d+w*T,y=t.components[8],b=t.components[9],g=t.components[10],w=t.components[11],s.components[8]=y*i+b*h+g*l+w*v,s.components[9]=y*n+b*c+g*m+w*B,s.components[10]=y*o+b*p+g*x+w*S,s.components[11]=y*r+b*f+g*d+w*T,y=t.components[12],b=t.components[13],g=t.components[14],w=t.components[15],s.components[12]=y*i+b*h+g*l+w*v,s.components[13]=y*n+b*c+g*m+w*B,s.components[14]=y*o+b*p+g*x+w*S,s.components[15]=y*r+b*f+g*d+w*T,s}static perspective(e,t,s,i){const n=new G,o=1/Math.tan(e/2);if(n.components[0]=o/t,n.components[5]=o,n.components[11]=-1,n.components[15]=0,i!==1/0){const r=1/(s-i);n.components[10]=i*r,n.components[14]=i*s*r}else n.components[10]=-1,n.components[14]=-s;return n}static lookAt(e,t,s){const i=new G,n=1e-6;let o,r,h,c,p,f,l,m,x,d;const v=e.x,B=e.y,S=e.z,T=s.x,y=s.y,b=s.z,g=t.x,w=t.y,E=t.z;return Math.abs(v-g)<n&&Math.abs(B-w)<n&&Math.abs(S-E)<n?(console.warn("Look At too close to Position"),new G):(l=v-g,m=B-w,x=S-E,d=1/Math.hypot(l,m,x),l*=d,m*=d,x*=d,o=y*x-b*m,r=b*l-T*x,h=T*m-y*l,d=Math.hypot(o,r,h),d?(d=1/d,o*=d,r*=d,h*=d):(o=0,r=0,h=0),c=m*h-x*r,p=x*o-l*h,f=l*r-m*o,d=Math.hypot(c,p,f),d?(d=1/d,c*=d,p*=d,f*=d):(c=0,p=0,f=0),i.components[0]=o,i.components[1]=c,i.components[2]=l,i.components[3]=0,i.components[4]=r,i.components[5]=p,i.components[6]=m,i.components[7]=0,i.components[8]=h,i.components[9]=f,i.components[10]=x,i.components[11]=0,i.components[12]=-(o*v+r*B+h*S),i.components[13]=-(c*v+p*B+f*S),i.components[14]=-(l*v+m*B+x*S),i.components[15]=1,i)}copyFrom(e){return this.components.set(e.components),this}invert(){const e=this.components[0],t=this.components[1],s=this.components[2],i=this.components[3],n=this.components[4],o=this.components[5],r=this.components[6],h=this.components[7],c=this.components[8],p=this.components[9],f=this.components[10],l=this.components[11],m=this.components[12],x=this.components[13],d=this.components[14],v=this.components[15],B=e*o-t*n,S=e*r-s*n,T=e*h-i*n,y=t*r-s*o,b=t*h-i*o,g=s*h-i*r,w=c*x-p*m,E=c*d-f*m,k=c*v-l*m,R=p*d-f*x,A=p*v-l*x,I=f*v-l*d,$=B*I-S*A+T*R+y*k-b*E+g*w;if($===0)return console.warn("Determinant is 0. Matrix not inverted"),this;const P=1/$;return this.components[0]=(o*I-r*A+h*R)*P,this.components[1]=(s*A-t*I-i*R)*P,this.components[2]=(x*g-d*b+v*y)*P,this.components[3]=(f*b-p*g-l*y)*P,this.components[4]=(r*k-n*I-h*E)*P,this.components[5]=(e*I-s*k+i*E)*P,this.components[6]=(d*T-m*g-v*S)*P,this.components[7]=(c*g-f*T+l*S)*P,this.components[8]=(n*A-o*k+h*w)*P,this.components[9]=(t*k-e*A-i*w)*P,this.components[10]=(m*b-x*T+v*B)*P,this.components[11]=(p*T-c*b-l*B)*P,this.components[12]=(o*E-n*R-r*w)*P,this.components[13]=(e*R-t*E+s*w)*P,this.components[14]=(x*S-m*y-d*B)*P,this.components[15]=(c*y-p*S+f*B)*P,this}}class X extends G{buffer;device;constructor(e,t,s=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST){super(),this.device=e,this.buffer=e.createBuffer({label:t,usage:s,size:64}),this.device=e}writeBuffer(){this.device.queue.writeBuffer(this.buffer,0,this.components.buffer)}}function O(u){return`/N-body-Simulation/${u}`}const Z=Math.PI/180;function z(u){return u*Z}const _=180/Math.PI;function Y(u){return u*_}function H(u,e,t){return Math.max(Math.min(u,t),e)}class J{keybinds;keysDown;constructor(e){this.keysDown=new Set,this.keybinds=new Set(e)}addEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}isKeyDown(e){return this.keysDown.has(e)}onKeyDown(e){const t=e.code;this.keybinds.has(t)&&this.keysDown.add(t)}onKeyUp(e){const t=e.code;this.keysDown.delete(t)}}class a{components;constructor(e=0,t=0,s=0){this.components=new Float32Array([e,t,s])}static random(e,t){const s=t-e;return new a(s*Math.random()+e,s*Math.random()+e,s*Math.random()+e)}static cross(e,t){const s=e.components[0],i=e.components[1],n=e.components[2],o=t.components[0],r=t.components[1],h=t.components[2];return new a(i*h-n*r,n*o-s*h,s*r-i*o)}static add(e,t){return new a(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2])}add(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}static subtract(e,t){return new a(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2])}subtract(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}static scale(e,t){return new a(e.components[0]*t,e.components[1]*t,e.components[2]*t)}scale(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}static normalise(e){return a.clone(e).normalise()}normalise(){const e=this.magnitude;if(e<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const t=1/e;return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}static clone(e){return new a(e.components[0],e.components[1],e.components[2])}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(e){this.components[0]=e}set y(e){this.components[1]=e}set z(e){this.components[2]=e}}class ee{position;forward;aspectRatio;near;far;movementSpeed;mouseSensitivity;pitch;yaw;fovRadians;keyboardManager;keybinds;constructor(e={}){this.position=e.position??new a,this.forward=new a(0,0,-1),this.aspectRatio=e.aspectRatio??16/9,this.near=e.near??.1,this.far=e.far??1e3,this.fovRadians=z(e.fovDegrees??60),this.movementSpeed=e.movementSpeed??1,this.mouseSensitivity=e.mouseSensitivity??1,this.pitch=0,this.yaw=-90,this.keybinds={forwards:e.keybinds?.forwards??"KeyW",backwards:e.keybinds?.backwards??"KeyS",left:e.keybinds?.left??"KeyA",right:e.keybinds?.right??"KeyD",up:e.keybinds?.up??"Space",down:e.keybinds?.down??"ShiftLeft"},this.keyboardManager=new J(Object.values(this.keybinds)),this.addEventListeners()}checkKeyboardInputs(e){const t=this.movementSpeed*e;if(this.keyboardManager.isKeyDown(this.keybinds.forwards)){const s=a.clone(this.forward);s.y=0,s.normalise(),this.position.add(a.scale(s,t))}if(this.keyboardManager.isKeyDown(this.keybinds.backwards)){const s=a.clone(this.forward);s.y=0,s.normalise(),this.position.subtract(a.scale(s,t))}if(this.keyboardManager.isKeyDown(this.keybinds.left)){const s=a.clone(this.forward);s.y=0,s.normalise(),this.position.subtract(a.cross(s,new a(0,1,0)).normalise().scale(t))}if(this.keyboardManager.isKeyDown(this.keybinds.right)){const s=a.clone(this.forward);s.y=0,s.normalise(),this.position.add(a.cross(s,new a(0,1,0)).normalise().scale(t))}this.keyboardManager.isKeyDown(this.keybinds.up)&&(this.position.y+=t),this.keyboardManager.isKeyDown(this.keybinds.down)&&(this.position.y-=t)}addEventListeners(){this.keyboardManager.addEventListeners(),document.addEventListener("mousemove",e=>{const t=e.movementX*this.mouseSensitivity,s=-e.movementY*this.mouseSensitivity;this.yaw+=t,this.pitch=H(this.pitch+s,-89.9,89.9),this.updateForwardVector()})}getPerspectiveMatrix(){return G.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}getViewMatrix(){const e=new a(0,1,0);return G.lookAt(this.position,a.add(this.position,this.forward),e)}getPerspectiveViewMatrix(){return G.multiplyMatrices(this.getPerspectiveMatrix(),this.getViewMatrix())}updateForwardVector(){const e=z(this.yaw),t=z(this.pitch),s=Math.cos(e),i=Math.cos(t),n=Math.sin(e),o=Math.sin(t),r=new a(s*i,o,n*i).normalise();this.forward=r}lookAt(e){this.forward=a.subtract(e,this.position).normalise(),this.yaw=Y(Math.atan2(this.forward.z,this.forward.x)),this.pitch=Y(Math.asin(this.forward.y))}}class U{shader;constructor(e,t,s){this.shader=e.createShaderModule({label:s,code:t})}static async fetch(e,t,s,i=n=>n){const n=await(await fetch(t)).text(),o=await U.preprocess(t,n);return new U(e,i(o),s)}static async preprocess(e,t){return U.resolveImports(e,t)}static async resolveImports(e,t,s=[]){const i=/#!import.*\s/g,n=e.split("/"),o=n.slice(0,n.length-1).join("/")+"/",r=t.match(i)?.map(c=>c.replaceAll(/(#!import)|\s/g,"")).filter(c=>!s.includes(c)).map(c=>o+c+".wgsl")??[];return((await Promise.all(r.map(async c=>{const p=await fetch(c);if(!p.ok)return"";const f=await p.text();return U.resolveImports(c,f,s)}))).join("")+t).replaceAll(i,"")}}class D{buffer;dataview;littleEndian;offset;constructor(e,t=!0,s=0){this.buffer=new ArrayBuffer(e),this.dataview=new DataView(this.buffer),this.littleEndian=t,this.offset=s}writeUint8(e){this.dataview.setUint8(this.offset,e),this.offset+=1}writeUint32(e){this.dataview.setUint32(this.offset,e,this.littleEndian),this.offset+=4}writeFloat32(e){this.dataview.setFloat32(this.offset,e,this.littleEndian),this.offset+=4}writeVec3f(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z)}writeMat4x4f(e){new Float32Array(this.buffer,this.offset,16).set(e.components),this.offset+=64}pad(e){this.offset+=e}}class C{mesh;scene;drawArgs;objects;initialised;device;constructor(e){this.initialised=!1,this.objects=[],this.mesh=e}initialise(e,t){this.initialised||(e.scenes.push(this),this.device=t,this.scene=e,this.mesh.initialise(t),this.drawArgs=t.createBuffer({label:"Draw Arguments",size:20,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.initialised=!0,this.updateBuffer(),this.updateDrawArgs())}updateBuffer(e=this.objects.length){if(!this.initialised)return;const t=new D(e*C.objectByteLength);for(let s=this.objects.length-e;s<this.objects.length;s++){const i=this.objects[s];t.writeMat4x4f(i.calculateModelMatrix()),t.writeUint32(i.textureID),t.pad(12)}this.device.queue.writeBuffer(this.scene.sceneBuffer,this.sceneByteOffset+(this.objects.length-e)*C.objectByteLength,t.buffer)}addObjects(e,t=!0){const s=this.scene?.scenes.indexOf(this),i=this.scene?.maxObjectsPerScene[s];for(const n of e){if(this.objects.length>=i){console.warn(`Maximum number of objects reached (${i}). New objects not added`);break}this.objects.push(n)}t&&this.updateDrawArgs()}removeObjects(e,t=!0){for(const s of e){const i=this.objects.indexOf(s);i!==-1&&this.objects.splice(i,1)}t&&this.updateDrawArgs()}updateDrawArgs(e=this.mesh.indexCount,t=this.objectCount){this.initialised&&this.device.queue.writeBuffer(this.drawArgs,0,new Uint32Array([e,t]))}get objectCount(){return this.objects.length}get sceneByteOffset(){const e=this.scene.scenes.indexOf(this);return this.scene.scenes.reduce((t,s,i)=>i>=e?t:t+s.byteLength,0)}get maxObjects(){return this.scene.maxObjectsPerScene[this.scene.scenes.indexOf(this)]}get byteLength(){return this.maxObjects*C.objectByteLength}static get objectByteLength(){return 80}}class te{maxObjectsPerScene;maxScenes;scenes;textureArray;sceneBuffer;initialised;constructor(e,t,s=128){this.textureArray=e,this.maxObjectsPerScene=typeof s=="number"?Array.from({length:t},()=>s):Array.from({length:t},(n,o)=>s[o]??128),this.maxScenes=t,this.scenes=[];const i=this.scenes.push.bind(this.scenes);this.scenes.push=(...n)=>{for(const o of n){if(this.scenes.length>=this.maxScenes){console.warn("Maximum number of scenes reached. New scenes not added");break}i(o)}return this.scenes.length},this.initialised=!1}initialise(e){if(!this.initialised){this.sceneBuffer=e.createBuffer({label:"Scene Buffer",size:this.maxScenes*this.maxObjectsPerScene.reduce((t,s)=>t+s,0)*C.objectByteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});for(const t of this.scenes)t.initialise(this,e),t.updateBuffer();this.initialised=!0}}}class M{label;texture;constructor(e,t){this.label=e,this.texture=t}static fromSources(e,t,s,i,n){const o=e.createTexture({label:t,format:"rgba8unorm",size:[i,n,s.length],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});for(let r=0;r<s.length;r++){const h=s[r];e.queue.copyExternalImageToTexture({source:h},{texture:o,origin:[0,0,r]},{width:i,height:n})}return new M(t,o)}static toBitmap(e){const t=e.map(async s=>await createImageBitmap(await(await fetch(O(s))).blob()));return Promise.all(t)}static async create(e,t,...s){const i=await M.toBitmap(s);return M.fromSources(e,t,i,i[0].width,i[1].height)}static createCubemap(e,t,s){return M.create(e,t,`${s}/px.png`,`${s}/nx.png`,`${s}/py.png`,`${s}/ny.png`,`${s}/pz.png`,`${s}/nz.png`)}}class N{label;inversePespectiveViewMatrix;bindGroups=[];device;activeSkybox;renderBindGroupLayout;renderPipeline;skyboxes;sampler;constructor(e,t,s,i){this.device=e,this.label=i,this.activeSkybox=-1,this.skyboxes=[],this.bindGroups=[],this.inversePespectiveViewMatrix=new X(e,`${this.label} Inverse Perspective View Matrix Buffer`),this.sampler=this.device.createSampler({label:`${this.label} Sampler`,minFilter:"linear",magFilter:"linear"}),this.renderBindGroupLayout=this.device.createBindGroupLayout({label:`${this.label} Bind Group Layout`,entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const n=this.device.createPipelineLayout({label:`${this.label} Render Pipeline Layout`,bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:`${this.label} Render Pipeline`,layout:n,vertex:{module:t.shader,entryPoint:"vertexMain"},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:s}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}})}static async create(e,t,s){const i=await U.fetch(e,O("shaders/skybox.wgsl"),`${s} Shader Module`);return new N(e,i,t,s)}addSkybox(e){const t=this.device.createBindGroup({label:`${this.label} ${e.label} Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix.buffer}}]});this.skyboxes.push(e),this.bindGroups.push(t),this.activeSkybox===-1&&(this.activeSkybox=this.skyboxes.length-1)}setActiveSkybox(e){if(e===null){this.activeSkybox=-1;return}this.skyboxes.includes(e)||this.addSkybox(e);const t=this.skyboxes.indexOf(e);this.activeSkybox=t}render(e,t){if(this.activeSkybox===-1){console.warn("No active skybox");return}this.inversePespectiveViewMatrix.copyFrom(t.getPerspectiveViewMatrix().invert()),this.inversePespectiveViewMatrix.writeBuffer(),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroups[this.activeSkybox]),e.draw(3)}}class F{scenes;canvas;camera;device;ctx;canvasFormat;gpuTimer;initialised;renderBindGroup;renderPipeline;depthTexture;skyboxRenderer;parametersBuffer;perspectiveViewMatrix;constructor(e,t,s){const i=e.getContext("webgpu");if(i===null)throw new Error("Could not create WebGPU Canvas Context");this.canvas=e,this.device=s,this.ctx=i,this.canvasFormat="rgba8unorm",this.camera=new ee(t.cameraOptions);const n=document.getElementById("renderFrameTime"),o=document.getElementById("fps");this.gpuTimer=new W(this.device,r=>{const h=r/1e3,c=r/1e6,p=r/1e9,f=c>1,l=(f?c:h).toFixed(2),m=f?"ms":"μs",x=1/p;n.textContent=l+m,o.textContent=x.toFixed(2)}),this.gpuTimer.canTimestamp||(n.textContent="[Not supported by browser]",o.textContent="[Not supported by browser]"),this.perspectiveViewMatrix=new X(s,"Perspective View Matrix"),this.initialised=!1}async initialise(e){if(this.initialised)return;this.scenes=e,this.parametersBuffer=this.device.createBuffer({label:"Parameters Buffer",size:this.scenes.maxScenes*256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),await this.initialiseRendering();const t=new D(this.scenes.maxScenes*256);for(let s=0;s<this.scenes.maxObjectsPerScene.length;s++){const i=this.scenes.maxObjectsPerScene[s-1]??0;t.writeUint32(i),t.pad(252)}this.device.queue.writeBuffer(this.parametersBuffer,0,t.buffer),new ResizeObserver(s=>{const i=s[0],n=i.devicePixelContentBoxSize[0].inlineSize,o=i.devicePixelContentBoxSize[0].blockSize;this.canvas.width=n,this.canvas.height=o,this.camera.aspectRatio=n/o,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture(),this.render()}).observe(this.canvas),this.initialised=!0}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const e=await M.createCubemap(this.device,"Skybox Texture","textures/skybox");this.skyboxRenderer=await N.create(this.device,this.canvasFormat,"Skybox Renderer"),this.skyboxRenderer.addSkybox(e);const t=await U.fetch(this.device,O("shaders/render.wgsl"));this.depthTexture=this.createDepthTexture();const s=this.device.createBindGroupLayout({label:"Render Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX},{binding:2,buffer:{type:"uniform",hasDynamicOffset:!0},visibility:GPUShaderStage.VERTEX},{binding:3,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:4,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:5,texture:{viewDimension:"cube-array"},visibility:GPUShaderStage.FRAGMENT}]});this.renderBindGroup=this.device.createBindGroup({label:"Render Bind Group",layout:s,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrix.buffer}},{binding:1,resource:{buffer:this.scenes.sceneBuffer}},{binding:2,resource:{buffer:this.parametersBuffer,size:256}},{binding:3,resource:e.texture.createView({dimension:"cube"})},{binding:4,resource:this.skyboxRenderer.sampler},{binding:5,resource:this.scenes.textureArray.texture.createView({dimension:"cube-array"})}]});const i=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[s]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:i,vertex:{module:t.shader,buffers:[{arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}]},fragment:{module:t.shader,targets:[{format:this.canvasFormat}]},primitive:{cullMode:"front"},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}})}render(){this.perspectiveViewMatrix.copyFrom(this.camera.getPerspectiveViewMatrix()),this.perspectiveViewMatrix.writeBuffer(),this.renderToCanvas()}renderToCanvas(){const e=this.device.createCommandEncoder(),t=this.gpuTimer.beginRenderPass(e,{colorAttachments:[{view:this.ctx.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});this.skyboxRenderer.render(t,this.camera),t.setPipeline(this.renderPipeline);for(let s=0;s<this.scenes.scenes.length;s++){const i=this.scenes.scenes[s];i.objectCount!==0&&(t.setBindGroup(0,this.renderBindGroup,[s*256]),i.mesh.bind(t),t.drawIndexedIndirect(i.drawArgs,0))}t.end(),this.device.queue.submit([e.finish()])}static async create(e,t){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const s=await navigator.gpu.requestAdapter();if(s===null)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const i=await s.requestDevice({requiredFeatures:F.requestFeatures(s,"timestamp-query")});if(i===null)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new F(e,t,i)}static requestFeatures(e,...t){return t.filter(s=>{const i=e.features.has(s);return i||console.warn(`GPU Feature ${s} not supported`),i})}}class se{settings;callbacks=[];frameID;lastFrameTime;totalTime;frame;constructor(e={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:e.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(e){this.callbacks.push(e)}tick(e){this.lastFrameTime<0&&(this.lastFrameTime=e);const t=e-this.lastFrameTime,s=this.totalTime+t;if(t<this.settings.wormholeThreshold){const i={deltaTime:t,totalTime:s,frame:this.frame++};for(const n of this.callbacks)n(i);this.totalTime=s}this.lastFrameTime=e,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return this.frameID!==null}}function ie(u){ne(),K("bodyCount",{onChange:e=>{u.bodyCount=e}}),K("restitution",{onChange:e=>{u.physicsShader.restitution=e},decimalPlaces:1})}function ne(){const u=document.getElementById("chevron"),e=document.getElementById("content");if(u===null)throw new Error("Could not find chevron element");if(e===null)throw new Error("Could not find info panel");u.addEventListener("click",()=>{u.classList.toggle("collapsed"),e.classList.toggle("collapsed")})}function K(u,e={}){const t=`${u}Input`,s=`${u}Value`,i=document.getElementById(t),n=document.getElementById(s);if(i===null)throw new Error(`Could not find slider with id ${t}`);if(n===null)throw new Error(`Could not find value display with id ${n}`);i.addEventListener("change",()=>{const o=e.processValue??(c=>c),r="processText"in e&&e.processText!==void 0?e.processText:"decimalPlaces"in e?c=>`(${c.toFixed(e.decimalPlaces)})`:c=>`(${c.toString()})`,h=o(parseFloat(i.value));n.textContent=r(h),e.onChange?.(h)})}function oe(u,e){return u+e-u%e}class re{position;scale;textureID;constructor(e={}){this.position=e.position??new a,this.scale=e.scale??new a(1,1,1),this.textureID=e.textureID??0}calculateModelMatrix(){const e=new G;return e.components[0]*=this.scale.x,e.components[1]*=this.scale.x,e.components[2]*=this.scale.x,e.components[4]*=this.scale.y,e.components[5]*=this.scale.y,e.components[6]*=this.scale.y,e.components[8]*=this.scale.z,e.components[9]*=this.scale.z,e.components[10]*=this.scale.z,e.components[12]=this.position.x,e.components[13]=this.position.y,e.components[14]=this.position.z,e}}class V extends re{static BYTE_LENGTH=32;mass;radius;initialVelocity;constructor(e,t,s,i){super({position:e,scale:new a(t,t,t)}),this.mass=s,this.radius=t,this.initialVelocity=i}writeToBuffer(e){e.writeVec3f(this.initialVelocity),e.writeFloat32(this.mass),e.writeFloat32(this.radius),e.pad(12)}}class L{static SETTINGS_BYTE_LENGTH=oe(12,16);restitution;simulation;device;gpuTimer;settingsBuffer;bodyStatesBuffer;bindGroup;computePipeline;constructor(e,t,s){this.device=t,this.simulation=s;const i=document.getElementById("computeFrameTime");this.gpuTimer=new W(t,h=>{const c=h/1e3,p=h/1e6,f=p>1,x=(f?p:c).toFixed(2)+(f?"ms":"μs");i.textContent=x}),this.restitution=1,this.settingsBuffer=t.createBuffer({label:"Physics Shader Settings Buffer",size:L.SETTINGS_BYTE_LENGTH,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.bodyStatesBuffer=t.createBuffer({label:"Physics Shader Body States Buffer",size:this.simulation.maxBodies*V.BYTE_LENGTH,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const n=new D(this.simulation.maxBodies*V.BYTE_LENGTH);for(const h of this.simulation.bodies)h.writeToBuffer(n);this.device.queue.writeBuffer(this.bodyStatesBuffer,0,n.buffer);const o=t.createBindGroupLayout({label:"Physics Shader Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.COMPUTE},{binding:1,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE},{binding:2,buffer:{type:"storage"},visibility:GPUShaderStage.COMPUTE}]});this.bindGroup=t.createBindGroup({label:"Physics Shader Bind Group",layout:o,entries:[{binding:0,resource:{buffer:this.settingsBuffer}},{binding:1,resource:{buffer:this.simulation.scene.sceneBuffer}},{binding:2,resource:{buffer:this.bodyStatesBuffer}}]});const r=t.createPipelineLayout({label:"Physics Shader Compute Pipeline Layout",bindGroupLayouts:[o]});this.computePipeline=t.createComputePipeline({label:"Physics Shader Compute Pipeline",layout:r,compute:{module:e.shader}})}updateSettings(e){const t=new D(L.SETTINGS_BYTE_LENGTH);t.writeUint32(this.simulation.bodyCount),t.writeFloat32(e),t.writeFloat32(this.restitution),this.device.queue.writeBuffer(this.settingsBuffer,0,t.buffer)}run(e){this.updateSettings(e);const t=this.device.createCommandEncoder(),s=this.gpuTimer.beginComputePass(t,{label:"Physics Shader Compute Pass"});s.setBindGroup(0,this.bindGroup),s.setPipeline(this.computePipeline),s.dispatchWorkgroups(Math.ceil(this.simulation.bodyCount/64),1,1),s.end(),this.device.queue.submit([t.finish()])}static async create(e,t){const s=await U.fetch(e,O("shaders/physics.wgsl"));return new L(s,e,t)}}class ae{vertexBuffer;indexBuffer;device;vertices;indices;rawVertices;rawIndices;label;constructor(e,t,s=""){this.rawVertices=e,this.rawIndices=t??null,this.label=s}initialise(e){this.device=e,this.update(this.rawVertices,this.rawIndices??void 0,!0)}update(e,t,s=!1){if(this.device)if(this.vertices=new Float32Array(e.map(i=>[i.position.x,i.position.y,i.position.z,i.normal.x,i.normal.y,i.normal.z]).flat()),(e.length!==this.rawVertices.length||s)&&(this.vertexBuffer?.destroy(),this.vertexBuffer=this.device.createBuffer({label:`${this.label} Vertex Buffer`,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,size:this.vertices.byteLength})),this.device.queue.writeBuffer(this.vertexBuffer,0,this.vertices.buffer),t!==void 0){const i=this.indexFormat==="uint16"?Uint16Array:Uint32Array;this.indices=new i(t),(this.rawIndices?.length!==t.length||s)&&(this.indexBuffer?.destroy(),this.indexBuffer=this.device.createBuffer({label:`${this.label} Index Buffer`,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,size:this.indices.byteLength})),this.device.queue.writeBuffer(this.indexBuffer,0,this.indices.buffer)}else this.indices=null,this.indexBuffer=null}bind(e,t=0){e.setVertexBuffer(t,this.vertexBuffer),this.indexBuffer!==null&&e.setIndexBuffer(this.indexBuffer,this.indexFormat)}get verticeCount(){return this.rawVertices.length}get indexCount(){return this.indices?.length??0}get indexFormat(){return this.vertices.length>65535?"uint32":"uint16"}}class q extends ae{constructor(e,t){const s=[],i=[],n=[new a(1,0,0),new a(-1,0,0),new a(0,1,0),new a(0,-1,0),new a(0,0,1),new a(0,0,-1)];for(let o=0;o<n.length;o++){const r=n[o],h=q.createCubeFace(r,o*(e+1)*(e+1),e,t);for(const c of h.vertices)s.push(c);for(const c of h.indices)i.push(c)}super(s,i)}static createCubeFace(e,t,s,i){const n=[],o=[],r=new a(e.y,e.z,e.x).scale(i),h=a.cross(e,r).normalise().scale(i),c=a.subtract(a.scale(e,.5*i),a.add(r,h).scale(.5)),p=a.scale(r,1/s),f=a.scale(h,1/s);for(let l=0;l<=s;l++)for(let m=0;m<=s;m++){const x=a.scale(p,l).add(a.scale(f,m)),d=a.add(c,x);if(n.push({position:d,normal:e}),l<s&&m<s){const v=t+l+m*(s+1);o.push(v,v+1,v+s+2,v,v+s+2,v+s+1)}}return{vertices:n,indices:o}}}class ce extends q{constructor(e,t){super(e,t*2),this.rawVertices.forEach(s=>{s.position.normalise().scale(t);const i=a.normalise(s.position);i.x*=Math.sqrt(1-.5*i.y*i.y-.5*i.z*i.z+i.y*i.y*i.z*i.z/3),i.y*=Math.sqrt(1-.5*i.x*i.x-.5*i.z*i.z+i.x*i.x*i.z*i.z/3),i.z*=Math.sqrt(1-.5*i.y*i.y-.5*i.x*i.x+i.y*i.y*i.x*i.x/3),s.normal=i.normalise()})}}class j extends M{textureCount;constructor(e,t,s){super(t,s),this.textureCount=e}random(){return Math.floor(Math.random()*this.textureCount)}static async create(e,t,...s){const i=await M.toBitmap(s.map(n=>[`${n}/px.png`,`${n}/nx.png`,`${n}/py.png`,`${n}/ny.png`,`${n}/pz.png`,`${n}/nz.png`]).flat());return new j(s.length,t,M.fromSources(e,t,i,i[0].width,i[0].height).texture)}}class he{scene;bodies;maxBodies;bodyScene;bodyRadius;bodySpawnRadius;_bodyCount;initialised;physicsShader;constructor(e={}){this.initialised=!1,this.bodies=[],this.bodyRadius=e.bodyRadius??1,this.maxBodies=e.maxBodies??128,this.bodyScene=new C(new ce(20,this.bodyRadius)),this._bodyCount=0;const t=e.bodyCount??10;this.bodySpawnRadius=e.bodySpawnRadius??1.5*this.bodyRadius*t,this.bodyCount=t}get bodyCount(){return this._bodyCount}set bodyCount(e){e=H(e,0,this.maxBodies);const t=e-this.bodyCount;if(t!==0){if(t>0){for(let s=0;s<t;s++){const i=a.random(-this.bodySpawnRadius,this.bodySpawnRadius),n=a.random(-1,1).scale(5*this.bodyRadius),o=1+.75*Math.random(),r=1e13*o,h=this.bodyRadius*o,c=new V(i,h,r,n);c.textureID=this.scene?.textureArray.random()??0,this.bodies.push(c)}this.bodyScene.addObjects(this.bodies.slice(this.bodyCount)),this.bodyScene.updateBuffer(t)}else{const s=this.bodies.splice(e,-t);this.bodyScene.removeObjects(s)}this._bodyCount=e}}tick(e){this.initialised&&this.physicsShader.run(e)}async initialise(e){if(this.initialised)return;const t=await j.create(e,"N-body Simulation Texture Array",...["Alpine","Gaseous1","Gaseous2","Gaseous3","Gaseous4","Icy","Martian","Savannah","Swamp","Terrestrial1","Terrestrial2","Terrestrial3","Terrestrial4","Tropical","Venusian","Volcanic"].map(s=>`textures/${s}`));this.scene=new te(t,1,[this.maxBodies]),this.scene.initialise(e),this.physicsShader=await L.create(e,this);for(const s of this.bodies)s.textureID=t.random();this.bodyScene.initialise(this.scene,e),this.initialised=!0}}async function ue(){const u=document.getElementById("message");u.style.zIndex="2";const e=document.getElementById("main"),t=new he({bodyCount:50}),s=await F.create(e,{cameraOptions:{mouseSensitivity:.1,movementSpeed:.01}});await t.initialise(s.device),await s.initialise(t.scene),s.camera.position=new a(30,30,30),s.camera.lookAt(new a(0,0,0)),ie(t);const i=new se({wormholeThreshold:100});i.addCallback(n=>{s.camera.checkKeyboardInputs(n.deltaTime),t.tick(n.deltaTime),s.render()}),i.start(),u.style.zIndex="unset",e.addEventListener("click",()=>{e.requestPointerLock()})}ue().catch(u=>{const e=u instanceof Error?u.message:JSON.stringify(u),t=document.querySelector("iframe"),s=document.getElementById("message");s.classList.add("error"),s.textContent=e,t.classList.remove("hidden");const i=document.getElementById("chevron"),n=document.getElementById("content");i?.classList.add("collapsed"),n?.classList.add("collapsed"),console.error(e)});
